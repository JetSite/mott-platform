# syntax=docker/dockerfile:1.7
# This file is generated by Dofigen v2.0.0
# See https://github.com/lenra-io/dofigen

# install
FROM oven/bun:1 AS install
WORKDIR /app/
COPY package.json ./
COPY bun.lockb ./
COPY turbo.json ./
COPY apps/core-ai/package.json ./apps/core-ai/package.json
COPY packages/db/package.json packages/db/package.json
COPY packages/emails/package.json packages/emails/package.json
COPY packages/error/package.json packages/error/package.json
COPY tooling/typescript/package.json tooling/typescript/package.json
COPY tooling/eslint/package.json tooling/eslint/package.json
COPY tooling/prettier/package.json tooling/prettier/package.json
RUN bun install

# build
FROM oven/bun:1 AS build
ENV NODE_ENV="production"
WORKDIR /app/apps/core-ai
COPY \
    "." "/app/"
COPY \
    --from=install \
    "/app/node_modules" "/app/node_modules"
RUN bun build --compile --sourcemap src/index.ts --outfile=app

# runtime
FROM debian@sha256:00558f781b91e90469812bad32002f311ab26ef241b4a1996f6600680ec82f5c AS runtime
COPY \
    --from=build \
    --chown=1000:1000 \
    --chmod=555 \
    --link \
    "/app/apps/core-ai/app" "/bin/"
USER 1000:1000
EXPOSE 3000
ENTRYPOINT ["/bin/app"]